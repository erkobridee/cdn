var loki=function(){"use strict";function t(t,e){var i,s=e||"parse-stringify";return"parse-stringify"===s&&(i=JSON.parse(JSON.stringify(t))),i}function e(){}function i(t){this.filename=t||"loki.db",this.collections=[],this.events={close:[]};var e=function(){return"undefined"!=typeof module&&module.exports?"NODEJS":void 0!==document?-1===document.URL.indexOf("http://")&&-1===document.URL.indexOf("https://")?"CORDOVA":"BROWSER":"CORDOVA"};this.ENV=e(),"NODEJS"===this.ENV&&(this.fs=require("fs"))}function s(t,e,i,s){return this.collection=t,this.searchIsChained=!e&&!i,this.filteredrows=[],this.filterInitialized=!1,"undefined"!=typeof e&&null!==e?this.find(e,s):"undefined"!=typeof i&&null!==i?this.where(i):this}function n(t,e,i){this.collection=t,this.name=e,this.persistent=!1,"undefined"!=typeof i&&(this.persistent=i),this.resultset=new s(t),this.resultdata=[],this.resultsdirty=!1,this.cachedresultset=null,this.filterPipeline=[],this.sortFunction=null,this.sortColumn=null,this.sortColumnDesc=!1,this.sortDirty=!1}function r(t,e,i){if(this.name=t,this.data=[],this.idIndex={},this.binaryIndices={},this.objType=t,this.transactional=i||!1,this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedData=null,this.maxId=0,this.DynamicViews=[],this.events={insert:[],update:[],close:[],flushbuffer:[],error:[],"delete":[]},this.ensureIndex(),"undefined"!=typeof e)for(var s=0;s<e.length;s++)this.ensureBinaryIndex(e[s]);this.on("insert",function(t){setTimeout(function(){t.meta.created=(new Date).getTime(),t.meta.revision=0},1)}),this.on("update",function(t){setTimeout(function(){t.meta.updated=(new Date).getTime(),t.meta.revision+=1},1)})}return e.prototype.events={},e.prototype.on=function(t,e){var i=this.events[t];return i||(i=this.events[t]=[]),i.push(e)-1},e.prototype.emit=function(t,e){if(this.events[t]){var i=this;return setTimeout(function(){i.events[t].forEach(function(t){Array.isArray(e)?t.apply(null,e):t.call(null,e)})},1),void 0}throw new Error("No event "+t+" defined")},e.prototype.remove=function(t,e){this.events[t]&&this.events[t].splice(e,1)},i.prototype=new e,i.prototype.close=function(t){t&&this.on("close",t),this.emit("close")},s.prototype.toJSON=function(){var t=this.copy();return t.collection=null,t},s.prototype.limit=function(t){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=Object.keys(this.collection.data));var e=this.copy();return e.filteredrows=e.filteredrows.slice(0,t),e},s.prototype.offset=function(t){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=Object.keys(this.collection.data));var e=this.copy();return e.filteredrows=e.filteredrows.splice(t),e},s.prototype.copy=function(){var t=new s(this.collection,null,null);return t.filteredrows=this.filteredrows.slice(),t.filterInitialized=this.filterInitialized,t},s.prototype.sort=function(t){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=Object.keys(this.collection.data));var e=function(t,e){return function(i,s){var n=e.collection.data[i],r=e.collection.data[s];return t(n,r)}}(t,this);return this.filteredrows.sort(e),this},s.prototype.simplesort=function(t,e){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=Object.keys(this.collection.data)),"undefined"==typeof e&&(e=!1);var i=function(t,e,i){return function(s,n){var r=i.collection.data[s],o=i.collection.data[n];if(r[t]===o[t])return 0;if(e){if(r[t]<o[t])return 1;if(r[t]>o[t])return-1}else{if(r[t]>o[t])return 1;if(r[t]<o[t])return-1}}}(t,e,this);return this.filteredrows.sort(i),this},s.prototype.calculateRange=function(t,e,i){var s=this.collection.data,n=this.collection.binaryIndices[e].values,r=0,o=n.length-1,a=null,h=s[n[r]][e],l=s[n[o]][e];if(h>i||i>l)return[0,-1];for(;s[n[r]][e]<s[n[o]][e];)a=Math.floor((r+o)/2),s[n[a]][e]<i?r=a+1:o=a;switch(t){case"$eq":return[r,o];case"$gt":return[o,s.length];case"$gte":return[o,s.length-1];case"$lt":return[0,r-1];case"$lte":return[0,r];default:return[0,s.length]}},s.prototype.find=function(t,e){function i(t,e){return t===e}function s(t,e){return t>e}function n(t,e){return t>=e}function r(t,e){return e>t}function o(t,e){return e>=t}function a(t,e){return t!==e}function h(t,e){return e.test(t)}function l(t,e){return Array.isArray(t)?-1!==t.indexOf(e):"string"==typeof t?-1!==t.indexOf(e):"object"==typeof t?t.hasOwnProperty(e):void 0}var c,u,d,f,p,y,m,w,v,g=t||"getAll",I={$eq:i,$gt:s,$gte:n,$lt:r,$lte:o,$ne:a,$regex:h,$contains:l},D=!1,b=[],x=null;if("undefined"==typeof e&&(e=!1),"getAll"===g)return this.searchIsChained?(this.filteredrows=Object.keys(this.collection.data),this):this.collection.data;var O=!1;for(f in g)if(g.hasOwnProperty(f)){if(c=f,-1!=f.indexOf(".")&&(O=!0),"object"!=typeof g[f])d="$eq",u=g[f];else{if("object"!=typeof g[f])throw"Do not know what you want to do.";for(p in g[f])g[f].hasOwnProperty(p)&&(d=p,u=g[f][p])}break}if("$regex"===d&&(u=RegExp(u)),null===this.collection.data)throw new TypeError;if((!this.searchIsChained||this.searchIsChained&&!this.filterInitialized)&&"$ne"!==d&&"$regex"!==d&&"$contains"!==d&&this.collection.binaryIndices.hasOwnProperty(c)&&(this.collection.ensureBinaryIndex(c),D=!0,x=this.collection.binaryIndices[c]),y=I[d],this.searchIsChained){if(this.filterInitialized){if(D)for(m=x,w=this.filteredrows.length;w--;)y(m[this.filteredrows[w]],u)&&b.push(this.filteredrows[w]);else if(m=this.collection.data,w=this.filteredrows.length,O)for(var C,V;w--;)C=m[this.filteredrows[w]],V=c.split("."),V.forEach(function(t){C=C[t]}),y(C,u)&&b.push(this.filteredrows[w]);else for(;w--;)y(m[this.filteredrows[w]][c],u)&&b.push(this.filteredrows[w]);return this.filteredrows=b,this}if(D){m=this.collection.data;for(var j=this.calculateRange(d,c,u,this),k=j[0];k<=j[1];k++)b.push(x.values[k]);this.filteredrows=b}else if(m=this.collection.data,w=m.length,O)for(var C,V;w--;)C=m[w],V=c.split("."),V.forEach(function(t){C=C[t]}),y(C,u)&&b.push(w);else for(;w--;)y(m[w][c],u)&&b.push(w);return this.filteredrows=b,this.filterInitialized=!0,this}if(D){m=this.collection.data,v=m.length;var j=this.calculateRange(d,c,u,this);if(e&&-1!==j[1])return this.data[j[0]];for(w=j[0];w<=j[1];w++)b.push(m[x.values[w]]);this.filteredrows=b}else if(m=this.collection.data,w=m.length,e){for(;w--;)if(y(m[w][c],u))return m[w]}else if(O)for(var C,V;w--;)C=m[w],V=c.split("."),V.forEach(function(t){C=C[t]}),y(C,u)&&b.push(m[w]);else for(;w--;)y(m[w][c],u)&&b.push(m[w]);return b},s.prototype.where=function(t){var e,i=[];if("function"!=typeof t)throw"Argument is not a stored view or a function";e=t;try{if(this.searchIsChained){if(this.filterInitialized){for(var s=this.filteredrows.length;s--;)e(this.collection.data[this.filteredrows[s]])===!0&&i.push(this.filteredrows[s]);return this.filteredrows=i,this}for(var s=this.collection.data.length;s--;)e(this.collection.data[s])===!0&&i.push(s);return this.filteredrows=i,this.filterInitialized=!0,this}for(var s=this.collection.data.length;s--;)e(this.collection.data[s])===!0&&i.push(this.collection.data[s]);return i}catch(n){throw n}},s.prototype.data=function(){var t=[];if(this.searchIsChained&&!this.filterInitialized){if(0===this.filteredrows.length)return this.collection.data;this.filterInitialized=!0}var e,i=this.collection.data,s=this.filteredrows,n=this.filteredrows.length;for(e=0;n>e;e++)t.push(i[s[e]]);return t},s.prototype.update=function(t){if("function"!=typeof t)throw"Argument is not a function";this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=Object.keys(this.collection.data));for(var e=this.filteredrows.length,i=this.collection.data,s=0;e>s;s++)t(i[this.filteredrows[s]]),this.collection.update(i[this.filteredrows[s]]);return this},s.prototype.remove=function(){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=Object.keys(this.collection.data));for(var t=this.filteredrows.length,e=0;t>e;e++)this.collection.remove(this.filteredrows[e]);return this.filteredrows=[],this},s.prototype.mapReduce=function(t,e){try{return e(this.data().map(t))}catch(i){throw i}},n.prototype.branchResultset=function(){return this.resultset.copy()},n.prototype.toJSON=function(){var t=new n(this.collection,this.name,this.persistent);return t.resultset=this.resultset,t.resultdata=this.resultdata,t.resultsdirty=this.resultsdirty,t.filterPipeline=this.filterPipeline,t.sortFunction=this.sortFunction,t.sortColumn=this.sortColumn,t.sortColumnDesc=this.sortColumnDesc,t.sortDirty=this.sortDirty,t.collection=null,t},n.prototype.applySort=function(t){return this.sortFunction=t,this.sortColumn=null,this.sortColumnDesc=!1,this.resultset.sort(t),this.sortDirty=!1,this},n.prototype.applySimpleSort=function(t,e){return"undefined"==typeof e&&(e=!1),this.sortColumn=t,this.sortColumnDesc=e,this.sortFunction=null,this.resultset.simplesort(t,e),this.sortDirty=!1,this},n.prototype.startTransaction=function(){return this.cachedresultset=this.resultset.copy(),this},n.prototype.commit=function(){return this.cachedresultset=null,this},n.prototype.rollback=function(){return this.resultset=this.cachedresultset,this.persistent&&(this.resultdata=this.resultset.data()),this},n.prototype.applyFind=function(t){return this.filterPipeline.push({type:"find",val:t}),this.resultset.find(t),(this.sortFunction||this.sortColumn)&&(this.sortDirty=!0),this.persistent&&(this.resultsdirty=!0),this},n.prototype.applyWhere=function(t){return this.filterPipeline.push({type:"where",val:t}),this.resultset.where(t),(this.sortFunction||this.sortColumn)&&(this.sortDirty=!0),this.persistent&&(this.resultsdirty=!0),this},n.prototype.data=function(){return this.sortDirty&&(this.sortFunction&&this.resultset.sort(this.sortFunction),this.sortColumn&&this.resultset.simplesort(this.sortColumn,this.sortColumnDesc),this.sortDirty=!1,this.persistent&&(this.resultsdirty=!0)),this.persistent?(this.resultsdirty&&(this.resultdata=this.resultset.data(),this.resultsdirty=!1),this.resultdata):this.resultset.data()},n.prototype.evaluateDocument=function(t){var e=this.resultset.filteredrows,i=e.indexOf(t),n=e.length,r=new s(this.collection);r.filteredrows=[t],r.filterInitialized=!0;for(var o=0;o<this.filterPipeline.length;o++)switch(this.filterPipeline[o].type){case"find":r.find(this.filterPipeline[o].val);break;case"where":r.where(this.filterPipeline[o].val)}var a=0===r.filteredrows.length?-1:0;return-1!=i||-1!=a?-1===i&&-1!==a?(e.push(t),this.persistent&&this.resultdata.push(this.collection.data[t]),(this.sortFunction||this.sortColumn)&&(this.sortDirty=!0),void 0):-1!==i&&-1===a?(n-1>i?(e[i]=e[n-1],e.length=n-1,this.persistent&&(this.resultdata[i]=this.resultdata[n-1],this.resultdata.length=n-1)):(e.length=n-1,this.persistent&&(this.resultdata.length=n-1)),void 0):-1!==i&&-1!==a?(this.persistent&&(this.resultdata[i]=this.collection.data[t]),(this.sortFunction||this.sortColumn)&&(this.sortDirty=!0),void 0):void 0:void 0},n.prototype.removeDocument=function(t){var e=this.resultset.filteredrows,i=e.indexOf(t),s=e.length;-1!==i&&(s-1>i?(e[i]=e[s-1],e.length=s-1,this.resultdata[i]=this.resultdata[s-1],this.resultdata.length=s-1):(e.length=s-1,this.resultdata.length=s-1))},n.prototype.mapReduce=function(t,e){try{return e(this.data().map(t))}catch(i){throw i}},r.prototype=new e,i.prototype.addCollection=function(t,e,i){var s=new r(t,e,i);return this.collections.push(s),s},i.prototype.loadCollection=function(t){this.collections.push(t)},i.prototype.getCollection=function(t){var e,i=!1,s=this.collections.length;for(e=0;s>e;e+=1)if(this.collections[e].name===t)return i=!0,this.collections[e];if(!i)throw"No such collection"},i.prototype.listCollections=function(){for(var t=this.collections.length,e=[];t--;)e.push({name:this.collections[t].name,type:this.collections[t].objType,count:this.collections[t].data.length});return e},i.prototype.removeCollection=function(t){var e=0,i=this.collections.length;for(e;i>e;e+=1)if(this.collections[e].name===t){this.collections.splice(e,1);break}},i.prototype.getName=function(){return this.name},i.prototype.serialize=function(){return JSON.stringify(this)},i.prototype.toJson=i.prototype.serialize,i.prototype.loadJSON=function(t){var e,i,s,n,r=JSON.parse(t),o=0,a=r.collections.length;for(this.name=r.name,this.collections=[],o;a>o;o+=1){for(e=r.collections[o],i=this.addCollection(e.name),s=e.data.length,n=0;s>n;n++)i.data[n]=e.data[n];if(i.maxId=0===e.data.length?0:e.data.maxId,i.idIndex=e.idIndex,"undefined"!=typeof e.indices&&(i.idIndex=e.indices.id),"undefined"!=typeof e.binaryIndices&&(i.binaryIndices=e.binaryIndices),i.transactional=e.transactional,i.ensureIndex(),"undefined"!=typeof e.DynamicViews)for(var h=0;h<e.DynamicViews.length;h++){var l=e.DynamicViews[h],c=i.addDynamicView(l.name,l.persistent);c.resultdata=l.resultdata,c.resultsdirty=l.resultsdirty,c.filterPipeline=l.filterPipeline,c.sortColumn=l.sortColumn,c.sortColumnDesc=l.sortColumnDesc,c.sortFunction=l.sortFunction,c.sortDirty=l.sortDirty,c.resultset.filteredrows=l.resultset.filteredrows,c.resultset.searchIsChained=l.resultset.searchIsChained,c.resultset.filterInitialized=l.resultset.filterInitialized}}},i.prototype.loadDatabase=function(t){var e=t||function(){},i=this;"NODEJS"===this.ENV&&this.fs.readFile(this.filename,{encoding:"utf8"},function(t,s){if(t)throw t;i.loadJSON(s),e(s)})},i.prototype.saveToDisk=function(t){var e=t||function(){},i=this;"NODEJS"===this.ENV&&this.fs.exists(this.filename,function(t){t&&i.fs.unlink(i.filename),i.fs.writeFile(i.filename,i.serialize(),function(t){if(t)throw t;e()})})},i.prototype.save=i.prototype.saveToDisk,r.prototype.ensureBinaryIndex=function(t,e){if("undefined"==typeof e&&(e=!1),null===t||void 0===t)throw"Attempting to set index without an associated property";if(this.binaryIndices.hasOwnProperty(t)&&!e){if(!this.binaryIndices[t].dirty)return}else this.binaryIndices[t]={name:t,dirty:!0,values:[]};var i,s=this.data.length,n=0;for(i=this.binaryIndices[t],n;s>n;n+=1)i.values.push(n);var r=function(t,e){return function(i,s){var n=e.data[i],r=e.data[s];return n[t]===r[t]?0:n[t]>r[t]?1:n[t]<r[t]?-1:void 0}}(t,this);i.values.sort(r),i.dirty=!1},r.prototype.ensureAllBinaryIndexes=function(t){for(var e=Object.keys(this.binaryIndices),i=e.length;i--;)this.ensureBinaryIndex(e[i],t)},r.prototype.flagBinaryIndexesDirty=function(){for(var t=Object.keys(this.binaryIndices),e=t.length;e--;)this.binaryIndices[t[e]].dirty=!0},r.prototype.ensureIndex=function(){var t=this.data.length,e=0;for(this.idIndex=[],e;t>e;e+=1)this.idIndex.push(this.data[e].id)},r.prototype.ensureIndexAsync=function(t){this.async(function(){this.ensureIndex()},t)},r.prototype.addDynamicView=function(t,e){var i=new n(this,t,e);return this.DynamicViews.push(i),i},r.prototype.removeDynamicView=function(t){for(var e=0;e<this.DynamicViews.length;e++)this.DynamicViews[e].name===t&&this.DynamicViews.splice(e,1)},r.prototype.getDynamicView=function(t){for(var e=0;e<this.DynamicViews.length;e++)if(this.DynamicViews[e].name===t)return this.DynamicViews[e]},r.prototype.findAndUpdate=function(t,e){var i,s=this.where(t),n=0;try{for(n;n<s.length;n++)i=e(s[n]),this.update(i)}catch(r){this.rollback(),console.error(r.message)}},r.prototype.insert=function(t){var e=this;if(Array.isArray(t))return t.forEach(function(t){t.objType=e.objType,"undefined"==typeof t.meta&&(t.meta={}),e.add(t),e.emit("insert",t)}),t;if("object"!=typeof t)throw new TypeError("Document needs to be an object");if(!t){var i=new Error("Object cannot be null");throw this.emit("error",i),i}return t.objType=this.objType,"undefined"==typeof t.meta&&(t.meta={}),this.add(t),this.emit("insert",t),t},r.prototype.clear=function(){this.data=[],this.idIndex={},this.binaryIndices={},this.cachedIndex=null,this.cachedData=null,this.maxId=0,this.DynamicViews=[]},r.prototype.update=function(t){if(Object.keys(this.binaryIndices).length>0&&this.flagBinaryIndexesDirty(),Array.isArray(t)){var e=0,i=t.length;for(e;i>e;e+=1)this.update(t[e])}else{if(!t.hasOwnProperty("id"))throw"Trying to update unsynced document. Please save the document first by using insert() or addMany()";try{this.startTransaction();var s,n,r=this.get(t.id,!0);if(!r)throw new Error("Trying to update a document not in collection.");s=r[0],n=r[1],this.data[n]=t;for(var o=0;o<this.DynamicViews.length;o++)this.DynamicViews[o].evaluateDocument(n);this.idIndex[n]=s.id,this.commit(),this.emit("update",t)}catch(a){throw this.rollback(),console.error(a.message),this.emit("error",a),a}}},r.prototype.add=function(t){var e,i=this.DynamicViews.length;if("object"!=typeof t)throw"Object being added needs to be an object";if(Object.keys(this.binaryIndices).length>0&&this.flagBinaryIndexesDirty(),"undefined"!=typeof t.id){if("undefined"!=typeof t.meta.version)throw"Document is already in collection, please use update()";t.originalId=t.id,delete t.id}try{this.startTransaction(),this.maxId++;var e;for(isNaN(this.maxId)&&(this.maxId=this.data[this.data.length-1].id+1),t.id=this.maxId,t.meta.version=0,this.data.push(t),e=0;i>e;e++)this.DynamicViews[e].evaluateDocument(this.data.length-1);return this.idIndex.push(t.id),this.commit(),t}catch(s){this.rollback(),console.error(s.message)}},r.prototype.remove=function(t){if("object"!=typeof t)throw"Parameter is not an object";if(Array.isArray(t)){var e=0,i=t.length;for(e;i>e;e+=1)this.remove(t[e])}else{if(!t.hasOwnProperty("id"))throw"Object is not a document stored in the collection";Object.keys(this.binaryIndices).length>0&&this.flagBinaryIndexesDirty();try{this.startTransaction();for(var s=this.get(t.id,!0),n=s[1],r=0;r<this.DynamicViews.length;r++)this.DynamicViews[r].removeDocument(n);this.data.splice(n,1),this.idIndex.splice(n,1),this.commit(),this.emit("delete")}catch(o){this.rollback(),console.error(o.message),this.emit("error",o)}}},r.prototype.get=function(t,e){var i=e||!1,s=this.idIndex,n=s.length-1,r=0,o=Math.floor(r+(n-r)/2);if(isNaN(t)&&(t=parseInt(t),isNaN(t)))throw"Passed id is not an integer";for(;s[r]<s[n];)o=Math.floor((r+n)/2),s[o]<t?r=o+1:n=o;return n===r&&s[r]===t?i?[this.data[r],r]:this.data[r]:null},r.prototype.findOne=function(t){return new s(this,t,null,!0)},r.prototype.chain=function(){return new s(this,null,null)},r.prototype.find=function(t){return"undefined"==typeof t&&(t="getAll"),new s(this,t,null)},r.prototype.findOneUnindexed=function(t,e){for(var i,s=this.data.length;s--;)if(this.data[s][t]===e)return i=this.data[s];return null},r.prototype.startTransaction=function(){if(this.transactional){this.cachedData=t(this.data,"parse-stringify"),this.cachedIndex=this.idIndex,this.cachedBinaryIndex=this.binaryIndices;for(var e=0;e<this.DynamicViews.length;e++)this.DynamicViews[e].startTransaction()}},r.prototype.commit=function(){if(this.transactional){this.cachedData=null,this.cachedIndex=null,this.cachedBinaryIndices=null;for(var t=0;t<this.DynamicViews.length;t++)this.DynamicViews[t].commit()}},r.prototype.rollback=function(){if(this.transactional){null!==this.cachedData&&null!==this.cachedIndex&&(this.data=this.cachedData,this.idIndex=this.cachedIndex,this.binaryIndices=this.cachedBinaryIndex);for(var t=0;t<this.DynamicViews.length;t++)this.DynamicViews[t].rollback()}},r.prototype.async=function(t,e){setTimeout(function(){if("function"!=typeof t)throw"Argument passed for async execution is not a function";t(),e()},0)},r.prototype.where=function(t){return new s(this,null,t)},r.prototype.mapReduce=function(t,e){try{return e(this.data.map(t))}catch(i){throw i}},r.prototype.no_op=function(){},i}();"undefined"!=typeof module&&module.exports&&(module.exports=loki);