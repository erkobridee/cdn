/*! lokijs 2013-11-28 */
var loki=function(){"use strict";function a(a){this.filename=a||"loki.db",this.collections=[];var b=function(){return"undefined"!=typeof module&&module.exports?"NODEJS":void 0!==document?-1===document.URL.indexOf("http://")&&-1===document.URL.indexOf("https://")?"CORDOVA":"BROWSER":"CORDOVA"};this.ENV=b(),"NODEJS"===this.ENV&&(this.fs=require("fs"))}function b(a,b,c,d){this.name=a,this.data=[],this.indices={},this.idIndex={},this.objType=b||"",this.transactional=d||!1,this.cachedIndex=null,this.cachedData=null,this.maxId=0,this.Views={};for(var e=c||["id"],f=e.length;f--;)this.ensureIndex(e[f]);this.ensureIndex("id")}return a.prototype.addCollection=function(a,c,d,e){var f=new b(a,c,d,e);return this.collections.push(f),f},a.prototype.loadCollection=function(a){this.collections.push(a)},a.prototype.getCollection=function(a){var b,c=!1,d=this.collections.length;for(b=0;d>b;b+=1)if(this.collections[b].name===a)return c=!0,this.collections[b];if(!c)throw"No such collection"},a.prototype.listCollections=function(){for(var a=this.collections.length,b=[];a--;)b.push({name:this.collections[a].name,type:this.collections[a].objType,count:this.collections[a].data.length});return b},a.prototype.removeCollection=function(a){var b=0,c=this.collections.length;for(b;c>b;b+=1)this.collections[b].name===a&&this.collections.splice(b,1)},a.prototype.getName=function(){return this.name},a.prototype.serialize=function(){return JSON.stringify(this)},a.prototype.toJson=a.prototype.serialize,a.prototype.loadJSON=function(a){var b,c,d,e,f=JSON.parse(a),g=0,h=f.collections.length;for(this.name=f.name,this.collections=[],g;h>g;g+=1){for(b=f.collections[g],c=this.addCollection(b.name,b.objType),d=b.data.length,e=0;d>e;e++)c.data[e]=b.data[e];c.maxId=b.data.maxId,c.indices=b.indices,c.idIndex=b.indices.id,c.transactional=b.transactional,c.ensureAllIndexes()}},a.prototype.loadDatabase=function(a){var b=a||function(){},c=this;"NODEJS"===this.ENV&&this.fs.readFile(this.filename,{encoding:"utf8"},function(a,d){if(a)throw a;c.loadJSON(d),b(d)})},a.prototype.saveToDisk=function(a){var b=a||function(){},c=this;"NODEJS"===this.ENV&&this.fs.exists(this.filename,function(a){a&&c.fs.unlink(c.filename),c.fs.writeFile(c.filename,c.serialize(),function(a){if(a)throw a;b()})})},a.prototype.save=a.prototype.saveToDisk,b.prototype.ensureIndex=function(a){if(null===a||void 0===a)throw"Attempting to set index without an associated property";var b,c=this.data.length,d=0;for(this.indices.hasOwnProperty(a)?b=this.indices[a]:(this.indices[a]=[],b=this.indices[a]),d;c>d;d+=1)b.push(this.data[d][a]);"id"===a&&(this.idIndex=b)},b.prototype.ensureIndexAsync=function(a,b){this.async(function(){this.ensureIndex(a)},b)},b.prototype.ensureAllIndexes=function(){for(var a=this.indices.length;a--;)this.ensureIndex(this.indices[a].name);0===a&&this.ensureIndex("id")},b.prototype.ensureAllIndexesAsync=function(a){this.async(function(){this.ensureAllIndexes()},a)},b.prototype.findAndUpdate=function(a,b){var c,d=this.view(a),e=0;try{for(e;e<d.length;e++)c=b(d[e]),this.update(c)}catch(f){this.rollback()}},b.prototype.insert=function(a){return a.id=null,a.objType=this.objType,this.add(a),a},b.prototype.clear=function(){this.data=[],this.indices={},this.idIndex={},this.cachedIndex=null,this.cachedData=null,this.maxId=0,this.Views={}},b.prototype.update=function(a){if(!a.hasOwnProperty("id"))throw"Trying to update unsynced document. Please save the document first by using add() or addMany()";try{this.startTransaction();var b,c=this.get(a.id,!0),d=c[0],e=c[1];this.data[e]=a;for(b in this.indices)this.indices.hasOwnProperty(b)&&(this.indices[b][e]=d[b]);this.commit()}catch(f){this.rollback()}},b.prototype.add=function(a){if("object"!=typeof a)throw"Object being added needs to be an object";if(""===this.objType&&0===this.data.length)this.objType=a.objType;else{if(this.objType!==a.objType)throw"Object type ["+a.objType+"] is incongruent with collection type ["+this.objType+"]";if(""===this.objType)throw"Object is not a model";if(null!==a.id&&a.id>0)throw"Document is already in collection, please use update()";try{this.startTransaction(),this.maxId++;var b;isNaN(this.maxId)&&(this.maxId=this.data[this.data.length-1].id+1),a.id=this.maxId,this.data.push(a);for(b in this.indices)this.indices.hasOwnProperty(b)&&this.indices[b].push(a[b]);return this.commit(),a}catch(c){this.rollback()}}},b.prototype.addMany=function(){for(var a=arguments.length;a--;)this.add(arguments[a])},b.prototype.remove=function(a){if("object"!=typeof a)throw"Parameter is not an object";if(!a.hasOwnProperty("id"))throw"Object is not a document stored in the collection";try{this.startTransaction();var b,c=this.get(a.id,!0),d=c[1];this.data.splice(d,1);for(b in this.indices)this.indices.hasOwnProperty(b)&&this.indices[b].splice(d,1);this.commit()}catch(e){this.rollback()}},b.prototype.get=function(a,b){var c=b||!1,d=this.indices.id,e=d.length-1,f=0,g=Math.floor(f+(e-f)/2);if(isNaN(a)&&(a=parseInt(a),isNaN(a)))throw"Passed id is not an integer";for(;d[f]<d[e];)g=Math.floor((f+e)/2),d[g]<a?f=g+1:e=g;return e===f&&d[f]===a?c?[this.data[f],f]:this.data[f]:null},b.prototype.findOne=function(a,b){var c,d,e=!1,f=null,g=this.indices.length;for(g in this.indices)if(this.indices.hasOwnProperty(g)&&g===a){e=!0,f=this.indices[g];break}if(!e)return this.findOneUnindexed(a,b);for(c=f.data.length;c--;)if(f.data[c]===b)return d=this.data[c];return null},b.prototype.find=function(a){function b(a,b){return a===b}function c(a,b){return a>b}function d(a,b){return a>=b}function e(a,b){return b>a}function f(a,b){return b>=a}function g(a,b){return a!==b}var h,i,j,k,l,m,n,o,p=a||"getAll",q={$eq:b,$gt:c,$gte:d,$lt:e,$lte:f,$ne:g},r=!1,s=null,t=this.indices.length,u=[];if("getAll"===p)return this.data;for(k in p)if(p.hasOwnProperty(k)){if(h=k,"object"!=typeof p[k])j="$eq",i=p[k];else{if("object"!=typeof p[k])throw"Do not know what you want to do.";for(l in p[k])p[k].hasOwnProperty(l)&&(j=l,i=p[k][l])}break}if(null===this.data)throw new TypeError;for(;t--;)this.indices[t].name===h&&(r=!0,s=this.indices[t]);if(m=q[j],r)for(n=s.data,o=n.length;o--;)m(n[o],i)&&u.push(this.data[o]);else for(n=this.data,o=n.length;o--;)m(n[o][h],i)&&u.push(n[o]);return u},b.prototype.findOneUnindexed=function(a,b){for(var c,d=this.data.length;d--;)if(this.data[d][a]===b)return c=this.data[d];return null},b.prototype.rollback=function(){this.transactional&&null!==this.cachedData&&null!==this.cachedIndex&&(this.data=this.cachedData,this.indices=this.cachedIndex)},b.prototype.startTransaction=function(){this.transactional&&(this.cachedData=this.data,this.cachedIndex=this.indices)},b.prototype.commit=function(){this.transactional&&(this.cachedData=null,this.cachedIndex=null)},b.prototype.async=function(a,b){setTimeout(function(){if("function"!=typeof a)throw"Argument passed for async execution is not a function";a(),b()},0)},b.prototype.view=function(a){var b,c=[],d=this.data.length;if("string"==typeof a&&"function"==typeof this.Views[a])b=this.Views[a];else{if("function"!=typeof a)throw"Argument is not a stored view or a function";b=a}try{for(;d--;)b(this.data[d])===!0&&(c[d]=this.data[d]);return c}catch(e){throw e}},b.prototype.storeView=function(a,b){"function"==typeof b&&(this.Views[a]=b)},b.prototype.mapReduce=function(a,b){try{return b(this.data.map(a))}catch(c){throw c}},b.prototype.no_op=function(){},a}();"undefined"!=typeof module&&module.exports&&(module.exports=loki);